{{plugin-outlet name="topic" args=(hash model=model)}}

{{#let this.model.postStream as |postStream|}}
    {{#unless (and postStream.loaded postStream.loadedAllPosts)}}
        {{hide-application-footer}}
        {{hide-application-sidebar}}
    {{/unless}}
{{/let}}

<DiscourseTopic
    {{sticky-avatars}}
        @multiSelect={{this.multiSelect}}
        @enteredAt={{this.enteredAt}}
        @topic={{this.model}}
        @hasScrolled={{this.hasScrolled}}
>
    {{#if this.model}}
        <AddCategoryTagClasses
                @category={{this.model.category}}
                @tags={{this.model.tags}}
        />
        <AddTopicStatusClasses @topic={{this.model}} />
        {{body-class (concat "archetype-" this.model.archetype)}}
        <div class="container">
            <DiscourseBanner
                    @overlay={{this.hasScrolled}}
                    @hide={{this.model.errorLoading}}
            />
        </div>
    {{/if}}

    {{#if this.showSharedDraftControls}}
        <SharedDraftControls @topic={{this.model}} />
    {{/if}}

    <span>
    <PluginOutlet
            @name="topic-above-post-stream"
            @connectorTagName="div"
            @outletArgs={{hash
            model=this.model
            editFirstPost=(action "editFirstPost")
    }}
    />
  </span>

    {{#if this.model.postStream.loaded}}
        {{#if this.model.postStream.firstPostPresent}}
            <TopicTitle
                    @cancelled={{action "cancelEditingTopic"}}
                    @save={{action "finishedEditingTopic"}}
                    @model={{this.model}}
            >
                {{#if this.editingTopic}}
                    <div class="edit-topic-title">
                        <PrivateMessageGlyph @shouldShow={{this.model.isPrivateMessage}} />

                        <div class="edit-title__wrapper">
                            <PluginOutlet
                                    @name="edit-topic-title"
                                    @outletArgs={{hash model=this.model buffered=this.buffered}}
                            >
                                <TextField
                                        @id="edit-title"
                                        @value={{this.buffered.title}}
                                        @maxlength={{this.siteSettings.max_topic_title_length}}
                                        @autofocus="true"
                                />
                            </PluginOutlet>
                        </div>

                        {{#if this.showCategoryChooser}}
                            <div class="edit-category__wrapper">
                                <PluginOutlet
                                        @name="edit-topic-category"
                                        @outletArgs={{hash model=this.model buffered=this.buffered}}
                                >
                                    <CategoryChooser
                                            @value={{this.buffered.category_id}}
                                            @onChange={{action "topicCategoryChanged"}}
                                            class="small"
                                    />
                                </PluginOutlet>
                            </div>
                        {{/if}}

                        {{#if this.canEditTags}}
                            <div class="edit-tags__wrapper">
                                <PluginOutlet
                                        @name="edit-topic-tags"
                                        @outletArgs={{hash model=this.model buffered=this.buffered}}
                                >
                                    <MiniTagChooser
                                            @value={{this.buffered.tags}}
                                            @onChange={{action "topicTagsChanged"}}
                                            @options={{hash
                                            filterable=true
                                            categoryId=this.buffered.category_id
                                            minimum=this.minimumRequiredTags
                                            filterPlaceholder="tagging.choose_for_topic"
                                            useHeaderFilter=true
                                    }}
                                    />
                                </PluginOutlet>
                            </div>
                        {{/if}}

                        <PluginOutlet
                                @name="edit-topic"
                                @connectorTagName="div"
                                @outletArgs={{hash model=this.model buffered=this.buffered}}
                        />

                        <div class="edit-controls">
                            <DButton
                                    @action={{action "finishedEditingTopic"}}
                                    @icon="check"
                                    @ariaLabel="composer.save_edit"
                                    class="btn-primary submit-edit"
                            />
                            <DButton
                                    @action={{action "cancelEditingTopic"}}
                                    @icon="xmark"
                                    @ariaLabel="composer.cancel"
                                    class="btn-default cancel-edit"
                            />

                            {{#if this.canRemoveTopicFeaturedLink}}
                                <a
                                        href
                                    {{on "click" this.removeFeaturedLink}}
                                        class="remove-featured-link"
                                        title={{i18n "composer.remove_featured_link"}}
                                >
                                    {{d-icon "circle-xmark"}}
                                    {{this.featuredLinkDomain}}
                                </a>
                            {{/if}}
                        </div>
                    </div>

                {{else}}
                    <PluginOutlet
                            @name="topic-category-wrapper"
                            @outletArgs={{hash topic=this.model}}
                    >
                        <TopicCategory @topic={{this.model}} class="topic-category"/>
                    </PluginOutlet>

                    <h1 data-topic-id={{this.model.id}}>
                        {{#unless this.model.is_warning}}
                            {{#if this.canSendPms}}
                                <PrivateMessageGlyph
                                        @shouldShow={{this.model.isPrivateMessage}}
                                        @href={{this.pmPath}}
                                        @title="topic_statuses.personal_message.title"
                                        @ariaLabel="user.messages.inbox"
                                />
                            {{else}}
                                <PrivateMessageGlyph
                                        @shouldShow={{this.model.isPrivateMessage}}
                                />
                            {{/if}}
                        {{/unless}}

                        {{#if this.model.details.loaded}}
                            <TopicStatus @topic={{this.model}} />

                            <a
                                    href={{this.model.url}}
                                {{on "click" this.jumpTop}}
                                    class="fancy-title"
                            >
                                {{html-safe this.model.fancyTitle}}
                            </a>
                        {{/if}}

                        {{#if this.model.details.can_edit}}
                            <a
                                    href
                                {{on "click" this.editTopic}}
                                    class="edit-topic"
                                    title={{i18n "edit_topic"}}
                            >{{d-icon "pencil"}}</a>
                        {{/if}}

                        <PluginOutlet
                                @name="topic-title-suffix"
                                @outletArgs={{hash model=this.model}}
                        />
                    </h1>
                {{/if}}
            </TopicTitle>

            {{#if this.model.publishedPage}}
                <div class="published-page-notice">
                    <div class="details">
                        {{#if this.model.publishedPage.public}}
                            <span class="is-public">{{i18n
                                    "topic.publish_page.public"
                            }}</span>
                        {{/if}}
                        {{i18n "topic.publish_page.topic_published"}}
                        <div>
                            <a
                                    href={{this.model.publishedPage.url}}
                                    target="_blank"
                                    rel="noopener noreferrer"
                            >{{this.model.publishedPage.url}}</a>
                        </div>
                    </div>
                    <div class="controls">
                        <DButton
                                @icon="file"
                                @label="topic.publish_page.publishing_settings"
                                @action={{route-action "showPagePublish"}}
                        />
                    </div>
                </div>
            {{/if}}

        {{/if}}

        <div class="container posts">
            <div class="selected-posts {{unless this.multiSelect 'hidden'}}">
                <SelectedPosts
                        @selectedPostsCount={{this.selectedPostsCount}}
                        @canSelectAll={{this.canSelectAll}}
                        @canDeselectAll={{this.canDeselectAll}}
                        @canDeleteSelected={{this.canDeleteSelected}}
                        @canMergeTopic={{this.canMergeTopic}}
                        @canChangeOwner={{this.canChangeOwner}}
                        @canMergePosts={{this.canMergePosts}}
                        @toggleMultiSelect={{action "toggleMultiSelect"}}
                        @mergePosts={{action "mergePosts"}}
                        @deleteSelected={{action "deleteSelected"}}
                        @deselectAll={{action "deselectAll"}}
                        @selectAll={{action "selectAll"}}
                />
            </div>


            <div class="row">
                <section class="topic-area" id="topic" data-topic-id={{this.model.id}}>

                    <div class="posts-wrapper">
                        <ConditionalLoadingSpinner
                                @condition={{this.model.postStream.loadingAbove}}
                        />

                        <span>
              <PluginOutlet
                      @name="topic-above-posts"
                      @connectorTagName="div"
                      @outletArgs={{hash model=this.model}}
              />
            </span>

                        {{#unless this.model.postStream.loadingFilter}}
                            <ScrollingPostStream
                                    @posts={{this.postsToRender}}
                                    @canCreatePost={{this.model.details.can_create_post}}
                                    @multiSelect={{this.multiSelect}}
                                    @selectedPostsCount={{this.selectedPostsCount}}
                                    @filteredPostsCount={{this.model.postStream.filteredPostsCount}}
                                    @selectedQuery={{this.selectedQuery}}
                                    @gaps={{this.model.postStream.gaps}}
                                    @showReadIndicator={{this.model.show_read_indicator}}
                                    @streamFilters={{this.model.postStream.streamFilters}}
                                    @lastReadPostNumber={{this.userLastReadPostNumber}}
                                    @highestPostNumber={{this.highestPostNumber}}
                                    @showFlags={{action "showPostFlags"}}
                                    @editPost={{action "editPost"}}
                                    @showHistory={{route-action "showHistory"}}
                                    @showLogin={{route-action "showLogin"}}
                                    @showRawEmail={{route-action "showRawEmail"}}
                                    @deletePost={{action "deletePost"}}
                                    @permanentlyDeletePost={{action "permanentlyDeletePost"}}
                                    @recoverPost={{action "recoverPost"}}
                                    @expandHidden={{action "expandHidden"}}
                                    @toggleBookmark={{action "toggleBookmark"}}
                                    @togglePostType={{action "togglePostType"}}
                                    @rebakePost={{action "rebakePost"}}
                                    @changePostOwner={{action "changePostOwner"}}
                                    @grantBadge={{action "grantBadge"}}
                                    @changeNotice={{action "changeNotice"}}
                                    @lockPost={{action "lockPost"}}
                                    @unlockPost={{action "unlockPost"}}
                                    @unhidePost={{action "unhidePost"}}
                                    @replyToPost={{action "replyToPost"}}
                                    @toggleWiki={{action "toggleWiki"}}
                                    @showTopReplies={{action "showTopReplies"}}
                                    @cancelFilter={{action "cancelFilter"}}
                                    @removeAllowedUser={{action "removeAllowedUser"}}
                                    @removeAllowedGroup={{action "removeAllowedGroup"}}
                                    @topVisibleChanged={{action "topVisibleChanged"}}
                                    @currentPostChanged={{action "currentPostChanged"}}
                                    @currentPostScrolled={{action "currentPostScrolled"}}
                                    @bottomVisibleChanged={{action "bottomVisibleChanged"}}
                                    @togglePostSelection={{action "togglePostSelection"}}
                                    @selectReplies={{action "selectReplies"}}
                                    @selectBelow={{action "selectBelow"}}
                                    @fillGapBefore={{action "fillGapBefore"}}
                                    @fillGapAfter={{action "fillGapAfter"}}
                                    @showInvite={{route-action "showInvite"}}
                                    @showPagePublish={{route-action "showPagePublish"}}
                            />
                        {{/unless}}

                        <ConditionalLoadingSpinner
                                @condition={{this.model.postStream.loadingBelow}}
                        />
                    </div>
                    <div id="topic-bottom"></div>

                    <ConditionalLoadingSpinner
                            @condition={{this.model.postStream.loadingFilter}}
                    >
                        {{#if this.loadedAllPosts}}

                            {{#if this.model.pending_posts}}
                                <div class="pending-posts">
                                    {{#each this.model.pending_posts as |pending|}}
                                        <div
                                                class="reviewable-item"
                                                data-reviewable-id={{pending.id}}
                                        >
                                            <div class="reviewable-meta-data">
                        <span class="reviewable-type">
                            {{i18n "review.awaiting_approval"}}
                        </span>
                                                <span class="created-at">
                                                    {{age-with-tooltip pending.created_at}}
                                                </span>
                                            </div>
                                            <div class="post-contents-wrapper">
                                                <ReviewableCreatedBy @user={{this.currentUser}} />
                                                <div class="post-contents">
                                                    <ReviewableCreatedByName @user={{this.currentUser}} />
                                                    <div class="post-body">
                                                        <CookText
                                                                @rawText={{pending.raw}}
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="reviewable-actions">
                                                <PluginOutlet
                                                        @name="topic-additional-reviewable-actions"
                                                        @outletArgs={{hash pending=pending}}
                                                />
                                                <DButton
                                                        @label="review.delete"
                                                        @icon="trash-can"
                                                        @action={{fn (action "deletePending") pending}}
                                                        class="btn-danger"
                                                />
                                            </div>
                                        </div>
                                    {{/each}}
                                </div>
                            {{/if}}


                            <!-- composer -->

                            <div class="custom-comment-control">
                                <!--            <div class="custom-comment-control-title">Добавить комментарий</div>-->
                                <ComposerBody
                                        @composer={{this.composer.model}}
                                        @showPreview={{this.composer.isPreviewVisible}}
                                        @openIfDraft={{this.composer.openIfDraft}}
                                        @typed={{this.composer.typed}}
                                        @cancelled={{this.composer.cancelled}}
                                        @save={{this.composer.saveAction}}
                                >
                                    <div class="custom-comment-control-title">Добавить комментарий</div>

                                    {{html-class "composer-has-preview"}}
                                    <ComposerMessages
                                            @composer={{this.composer.model}}
                                            @messageCount={{this.composer.messageCount}}
                                            @addLinkLookup={{this.composer.addLinkLookup}}
                                    />

                                    {{#if this.composer.showFullScreenPrompt}}
                                        <ComposerFullscreenPrompt
                                                @removeFullScreenExitPrompt={{this.composer.removeFullScreenExitPrompt}}
                                        />
                                    {{/if}}

                                    {{#if this.composer.model.viewOpenOrFullscreen}}
                                        <div
                                                role="dialog"
                                                aria-label={{this.composer.ariaLabel}}
                                                class="reply-area
          {{if this.composer.canEditTags 'with-tags' 'without-tags'}}
                                                    {{if
                                                            this.composer.hasFormTemplate
                                                            'with-form-template'
                                                            'without-form-template'
                                                    }}
                                                    {{if
                                                            this.composer.model.showCategoryChooser
                                                            'with-category'
                                                            'without-category'
                                                    }}"
                                        >
        <span class="composer-open-plugin-outlet-container">
          <PluginOutlet
                  @name="composer-open"
                  @connectorTagName="div"
                  @outletArgs={{hash model=this.composer.model}}
          />
        </span>

                                            <div class="reply-to">
                                                {{#unless this.composer.model.viewFullscreen}}
                                                    <div class="reply-details">
                                                        <ComposerActionTitle
                                                                @model={{this.composer.model}}
                                                                @canWhisper={{this.composer.canWhisper}}
                                                        />

                                                        <PluginOutlet
                                                                @name="composer-action-after"
                                                                @outletArgs={{hash model=this.composer.model}}
                                                        />

                                                        {{#if this.site.desktopView}}
                                                            {{#if this.composer.model.unlistTopic}}
                                                                <span class="unlist">({{i18n "composer.unlist"}})</span>
                                                            {{/if}}
                                                            {{#if this.composer.isWhispering}}
                                                                {{#if this.composer.model.noBump}}
                                                                    <span class="no-bump">{{d-icon "anchor"}}</span>
                                                                {{/if}}
                                                            {{/if}}
                                                        {{/if}}

                                                        {{#if this.composer.canEdit}}
                                                            <LinkToInput
                                                                    @onClick={{this.composer.displayEditReason}}
                                                                    @showInput={{this.composer.showEditReason}}
                                                                    @icon="circle-info"
                                                                    class="display-edit-reason"
                                                            >
                                                                <TextField
                                                                        @value={{this.composer.editReason}}
                                                                        @id="edit-reason"
                                                                        @maxlength="255"
                                                                        @placeholderKey="composer.edit_reason_placeholder"
                                                                />
                                                            </LinkToInput>
                                                        {{/if}}
                                                    </div>
                                                {{/unless}}

                                                <PluginOutlet
                                                        @name="before-composer-controls"
                                                        @outletArgs={{hash model=this.composer.model}}
                                                />

                                                <ComposerToggles
                                                        @composeState={{this.composer.model.composeState}}
                                                        @showToolbar={{this.composer.showToolbar}}
                                                        @toggleComposer={{this.composer.toggle}}
                                                        @toggleToolbar={{this.composer.toggleToolbar}}
                                                        @toggleFullscreen={{this.composer.fullscreenComposer}}
                                                        @disableTextarea={{this.composer.disableTextarea}}
                                                />
                                            </div>

                                            <ComposerEditor>
                                                <div class="composer-fields">
                                                    <PluginOutlet
                                                            @name="before-composer-fields"
                                                            @outletArgs={{hash model=this.composer.model}}
                                                    />
                                                    {{#unless this.composer.model.viewFullscreen}}
                                                        {{#if this.composer.model.canEditTitle}}
                                                            {{#if this.composer.model.creatingPrivateMessage}}
                                                                <div class="user-selector">
                                                                    <ComposerUserSelector
                                                                            @topicId={{this.composer.topicModel.id}}
                                                                            @recipients={{this.composer.model.targetRecipients}}
                                                                            @hasGroups={{this.composer.model.hasTargetGroups}}
                                                                            @focusTarget={{this.composer.focusTarget}}
                                                                            class={{concat-class
                                                                            "users-input"
                                                                            (if this.composer.showWarning "can-warn")
                                                                    }}
                                                                    />
                                                                    {{#if this.composer.showWarning}}
                                                                        <label class="add-warning">
                                                                            <Input
                                                                                    @type="checkbox"
                                                                                    @checked={{this.composer.model.isWarning}}
                                                                            />
                                                                            <span>{{i18n "composer.add_warning"}}</span>
                                                                        </label>
                                                                    {{/if}}
                                                                </div>
                                                            {{/if}}

                                                            <div class="title-and-category {{ 'with-preview'}}">
                                                                <ComposerTitle
                                                                        @composer={{this.composer.model}}
                                                                        @lastValidatedAt={{this.composer.lastValidatedAt}}
                                                                        @focusTarget={{this.composer.focusTarget}}
                                                                />

                                                                {{#if this.composer.model.showCategoryChooser}}
                                                                    <div class="category-input">
                                                                        <CategoryChooser
                                                                                @value={{this.composer.model.categoryId}}
                                                                                @onChange={{this.composer.updateCategory}}
                                                                                @options={{hash
                                                                                disabled=this.composer.disableCategoryChooser
                                                                                scopedCategoryId=this.composer.scopedCategoryId
                                                                                prioritizedCategoryId=this.composer.prioritizedCategoryId
                                                                        }}
                                                                        />
                                                                        <PluginOutlet
                                                                                @name="after-composer-category-input"
                                                                                @outletArgs={{hash composer=this.composer.model}}
                                                                        />
                                                                        <PopupInputTip
                                                                                @validation={{this.composer.categoryValidation}}
                                                                        />
                                                                    </div>
                                                                {{/if}}

                                                                {{#if this.composer.canEditTags}}
                                                                    <div class="tags-input">
                                                                        <MiniTagChooser
                                                                                @value={{this.composer.model.tags}}
                                                                                @onChange={{fn (mut this.composer.model.tags)}}
                                                                                @options={{hash
                                                                                disabled=this.composer.disableTagsChooser
                                                                                categoryId=this.composer.model.categoryId
                                                                                minimum=this.composer.model.minimumRequiredTags
                                                                        }}
                                                                        />
                                                                        <PluginOutlet
                                                                                @name="after-composer-tag-input"
                                                                                @outletArgs={{hash composer=this.composer.model}}
                                                                        />
                                                                        <PopupInputTip
                                                                                @validation={{this.composer.tagValidation}}
                                                                        />
                                                                    </div>
                                                                {{/if}}

                                                                <PluginOutlet
                                                                        @name="after-title-and-category"
                                                                        @outletArgs={{hash
                                                                        model=this.composer.model
                                                                        tagValidation=this.composer.tagValidation
                                                                        canEditTags=this.composer.canEditTags
                                                                        disabled=this.composer.disableTagsChooser
                                                                }}
                                                                />
                                                            </div>
                                                        {{/if}}

                                                        <span>
                <PluginOutlet
                        @name="composer-fields"
                        @connectorTagName="div"
                        @outletArgs={{hash
                        model=this.composer.model
                        showPreview=true
                }}
                />
              </span>
                                                    {{/unless}}
                                                </div>
                                            </ComposerEditor>

                                            <span>
          <PluginOutlet
                  @name="composer-after-composer-editor"
                  @outletArgs={{hash model=this.composer.model}}
          />
        </span>

                                            <div class="submit-panel">
          <span>
            <PluginOutlet
                    @name="composer-fields-below"
                    @connectorTagName="div"
                    @outletArgs={{hash model=this.composer.model}}
            />
          </span>

                                                <div class="save-or-cancel">
                                                    <ComposerSaveButton
                                                            @action={{this.composer.saveAction}}
                                                            @icon={{this.composer.saveIcon}}
                                                            @label={{this.composer.saveLabel}}
                                                            @forwardEvent={{true}}
                                                            @disableSubmit={{this.composer.disableSubmit}}
                                                    />

                                                    {{#if this.site.mobileView}}
                                                        <DButton
                                                                @action={{this.composer.cancel}}
                                                                class="cancel btn-transparent"
                                                                @icon={{if this.composer.canEdit "xmark" "trash-can"}}
                                                                @preventFocus={{true}}
                                                                @title="close"
                                                        />
                                                    {{else}}
                                                        <DButton
                                                                @action={{this.composer.cancel}}
                                                                class="cancel btn-transparent"
                                                                @preventFocus={{true}}
                                                                @title="close"
                                                                @label="close"
                                                        />
                                                    {{/if}}

                                                    {{#if this.site.mobileView}}
                                                        {{#if this.composer.whisperOrUnlistTopic}}
                                                            <span class="whisper">
                                                                {{d-icon "far-eye-slash"}}
                                                            </span>
                                                        {{/if}}

                                                        {{#if this.composer.model.noBump}}
                                                            <span class="no-bump">{{d-icon "anchor"}}</span>
                                                        {{/if}}
                                                    {{/if}}

                                                    <span>
              <PluginOutlet
                      @name="composer-after-save-or-cancel"
                      @outletArgs={{hash model=this.composer.model}}
              />
            </span>
                                                </div>

                                                {{#if this.site.mobileView}}
                                                    <span>
              <PluginOutlet
                      @name="composer-mobile-buttons-bottom"
                      @outletArgs={{hash model=this.composer.model}}
              />
            </span>

                                                    {{#if this.composer.allowUpload}}
                                                        <a
                                                                id="mobile-file-upload"
                                                                class="btn btn-default no-text mobile-file-upload
                  {{if this.composer.isUploading 'hidden'}}"
                                                                aria-label={{i18n "composer.upload_title"}}
                                                        >
                                                            {{d-icon this.composer.uploadIcon}}
                                                        </a>
                                                    {{/if}}

                                                    {{#if this.composer.allowPreview}}
                                                        <a
                                                                href
                                                                class="btn btn-default no-text mobile-preview"
                                                                title={{i18n "composer.show_preview"}}
                                                            {{on "click" this.composer.togglePreview}}
                                                                aria-label={{i18n "composer.show_preview"}}
                                                        >
                                                            {{d-icon "desktop"}}
                                                        </a>
                                                    {{/if}}

                                                    <DButton
                                                            @action={{this.composer.togglePreview}}
                                                            @title="composer.hide_preview"
                                                            @ariaLabel="composer.hide_preview"
                                                            @icon="pencil"
                                                            class="hide-preview"
                                                    />
                                                {{/if}}

                                                {{#if
                                                        (or this.composer.isUploading this.composer.isProcessingUpload)
                                                }}
                                                    <div id="file-uploading">
                                                        {{#if this.composer.isProcessingUpload}}
                                                            {{loading-spinner size="small"}}<span>{{i18n
                                                                "upload_selector.processing"
                                                        }}</span>
                                                        {{else}}
                                                            {{loading-spinner size="small"}}<span>{{i18n
                                                                "upload_selector.uploading"
                                                        }}
                                                            {{this.composer.uploadProgress}}%</span>
                                                        {{/if}}

                                                        {{#if this.composer.isCancellable}}
                                                            <a
                                                                    href
                                                                    id="cancel-file-upload"
                                                                {{on "click" this.composer.cancelUpload}}
                                                            >{{d-icon "xmark"}}</a>
                                                        {{/if}}
                                                    </div>
                                                {{/if}}

                                                <div
                                                        class={{if this.composer.isUploading "hidden"}}
                                                        id="draft-status"
                                                >
                                                    {{#if this.composer.model.draftStatus}}
                                                        <span
                                                                class="draft-error"
                                                                title={{this.composer.model.draftStatus}}
                                                        >
                {{#if this.composer.model.draftConflictUser}}
                    {{avatar
                            this.composer.model.draftConflictUser
                            imageSize="small"
                    }}
                    {{d-icon "user-pen"}}
                {{else}}
                    {{d-icon "triangle-exclamation"}}
                {{/if}}
                                                            {{#if this.site.desktopView}}
                                                                {{this.composer.model.draftStatus}}
                                                            {{/if}}
              </span>
                                                    {{/if}}
                                                </div>

                                                {{#if (and this.composer.allowPreview this.site.desktopView)}}
                                                    <DButton
                                                            @action={{this.composer.togglePreview}}
                                                            @translatedTitle={{this.composer.toggleText}}
                                                            @icon="angles-left"
                                                            class={{concat-class
                                                            "btn-transparent btn-mini-toggle toggle-preview"
                                                            (unless this.composer.isPreviewVisible "active")
                                                    }}
                                                    />
                                                {{/if}}
                                            </div>
                                        </div>
                                    {{else}}
                                        <div class="saving-text">
                                            {{#if this.composer.model.createdPost}}
                                                {{i18n "composer.saved"}}
                                                <a
                                                        href={{this.composer.createdPost.url}}
                                                    {{on "click" this.composer.viewNewReply}}
                                                        class="permalink"
                                                >{{i18n "composer.view_new_post"}}</a>
                                            {{else}}
                                                {{i18n "composer.saving"}}
                                                {{loading-spinner size="small"}}
                                            {{/if}}
                                        </div>

                                        <div class="draft-text">
                                            {{#if this.composer.model.topic}}
                                                {{d-icon "share"}}
                                                {{html-safe this.composer.draftTitle}}
                                            {{else}}
                                                {{i18n "composer.saved_draft"}}
                                            {{/if}}
                                        </div>

                                        <ComposerToggles
                                                @composeState={{this.composer.model.composeState}}
                                                @toggleFullscreen={{this.composer.openIfDraft}}
                                                @toggleComposer={{this.composer.toggle}}
                                                @toggleToolbar={{this.composer.toggleToolbar}}
                                        />
                                    {{/if}}
                                </ComposerBody>
                            </div>

                            <!-- composer -->


                            {{#if this.model.queued_posts_count}}
                                <div class="has-pending-posts">
                                    <div>
                                        {{html-safe
                                                (i18n
                                                        "review.topic_has_pending"
                                                        count=this.model.queued_posts_count
                                                )
                                        }}
                                    </div>

                                    <LinkTo
                                            @route="review"
                                            @query={{hash
                                            topic_id=this.model.id
                                            type="ReviewableQueuedPost"
                                            status="pending"
                                    }}
                                    >
                                        {{i18n "review.view_pending"}}
                                    </LinkTo>
                                </div>
                            {{/if}}

                            <SlowModeInfo
                                    @topic={{this.model}}
                                    @user={{this.currentUser}}
                                    @tagName=""
                            />

                            <TopicTimerInfo
                                    @topicClosed={{this.model.closed}}
                                    @statusType={{this.model.topic_timer.status_type}}
                                    @statusUpdate={{this.model.topic_status_update}}
                                    @executeAt={{this.model.topic_timer.execute_at}}
                                    @basedOnLastPost={{this.model.topic_timer.based_on_last_post}}
                                    @durationMinutes={{this.model.topic_timer.duration_minutes}}
                                    @categoryId={{this.model.topic_timer.category_id}}
                                    @showTopicTimerModal={{route-action "showTopicTimerModal"}}
                                    @removeTopicTimer={{action
                                    "removeTopicTimer"
                                    this.model.topic_timer.status_type
                                    "topic_timer"
                            }}
                            />

                            {{#if this.showSelectedPostsAtBottom}}
                                <div
                                        class="selected-posts
                    {{unless this.multiSelect 'hidden'}}
                                            {{if this.showSelectedPostsAtBottom 'hidden'}}"
                                >
                                    <SelectedPosts
                                            @selectedPostsCount={{this.selectedPostsCount}}
                                            @canSelectAll={{this.canSelectAll}}
                                            @canDeselectAll={{this.canDeselectAll}}
                                            @canDeleteSelected={{this.canDeleteSelected}}
                                            @canMergeTopic={{this.canMergeTopic}}
                                            @canChangeOwner={{this.canChangeOwner}}
                                            @canMergePosts={{this.canMergePosts}}
                                            @toggleMultiSelect={{action "toggleMultiSelect"}}
                                            @mergePosts={{action "mergePosts"}}
                                            @deleteSelected={{action "deleteSelected"}}
                                            @deselectAll={{action "deselectAll"}}
                                            @selectAll={{action "selectAll"}}
                                    />
                                </div>
                            {{/if}}

                        {{/if}}
                    </ConditionalLoadingSpinner>

                    <PluginOutlet
                            @name="topic-area-bottom"
                            @connectorTagName="div"
                            @outletArgs={{hash model=this.model}}
                    />
                </section>
            </div>

        </div>


        {{#if this.loadedAllPosts}}
            <span>
                <PluginOutlet
                        @name="topic-above-suggested"
                        @connectorTagName="div"
                        @outletArgs={{hash model=this.model}}
                />
            </span>

        {{/if}}
    {{else}}
        <div class="container">
            <ConditionalLoadingSpinner @condition={{this.noErrorYet}}>
                {{#if this.model.errorHtml}}
                    <div class="not-found">{{html-safe this.model.errorHtml}}</div>
                {{else}}
                    <div class="topic-error">
                        <div>{{this.model.errorMessage}}</div>
                        {{#if this.model.noRetry}}
                            {{#unless this.currentUser}}
                                <DButton
                                        @action={{route-action "showLogin"}}
                                        @icon="user"
                                        @label="log_in"
                                        class="btn-primary topic-retry"
                                />
                            {{/unless}}
                        {{else}}
                            <DButton
                                    @action={{action "retryLoading"}}
                                    @icon="arrows-rotate"
                                    @label="errors.buttons.again"
                                    class="btn-primary topic-retry"
                            />
                        {{/if}}
                    </div>
                    <ConditionalLoadingSpinner @condition={{this.retrying}} />
                {{/if}}
            </ConditionalLoadingSpinner>
        </div>
    {{/if}}

    <PostTextSelection
            @quoteState={{this.quoteState}}
            @selectText={{action "selectText"}}
            @buildQuoteMarkdown={{this.buildQuoteMarkdown}}
            @editPost={{action "editPost"}}
            @topic={{this.model}}
    />
</DiscourseTopic>